<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.twd.take_a_walk_duo.mappers.IMapMapper">


    <insert id="insertWalkArticle"
            useGeneratedKeys="true"
            keyProperty="index"
            keyColumn="index"
            parameterType="dev.twd.take_a_walk_duo.entities.bbs.ArticleEntity">
        INSERT INTO `twd_bbs`.`articles`
        (`user_email`, `board_id`, `title`, `content`, `thumbnail`, `thumbnail_type`, `view`, `written_on`,
         `modified_on`)
        VALUES (#{userEmail}, #{boardId}, #{title}, #{content}, #{thumbnail}, #{thumbnailType}, #{view},
                IFNULL(#{writtenOn}, DEFAULT(`written_on`)),
                IFNULL(#{modifiedOn}, DEFAULT(`modified_on`)))
    </insert>

    <insert id="insertLocation"
            useGeneratedKeys="true"
            keyProperty="index"
            keyColumn="index"
            parameterType="dev.twd.take_a_walk_duo.entities.bbs.map.LocationEntity">
        INSERT INTO `twd_bbs`.`location` (`article_index`, `address`, `latitude`, `longitude`)
        VALUES (#{articleIndex}, #{address}, #{latitude}, #{longitude});
    </insert>

    <select id="selectPlacesExceptImage"
    resultType="dev.twd.take_a_walk_duo.vos.map.PlaceVo">
        SELECT `article`.`index`                  AS 'index',
               `article`.`user_email`             AS 'userEmail',
               `article`.`board_id`               AS 'boardId',
               `article`.`title`                  AS 'title',
               `article`.`content`                AS 'content',
               `article`.`view`                   AS 'view',
               `article`.`written_on`             AS 'writtenOn',
               `article`.`modified_on`            AS 'modifiedOn',
               `location`.`latitude`              AS 'latitude',
               `location`.`longitude`             AS 'longitude',
               `location`.`address`               AS 'address',
               COUNT(`likeCount`.`article_index`) AS 'likeCount',
               COUNT(`commentCount`.`index`)      AS 'commentCount',
               (#{email} IS NOT NULL)             AS 'isSigned'
        FROM `twd_bbs`.`articles` AS `article`
                 LEFT JOIN `twd_bbs`.`location` AS `location` ON `article`.`index` = `location`.`article_index`
                 LEFT JOIN `twd_bbs`.`article_likes` AS `likeCount` ON `article`.`index` = `likeCount`.`article_index`
                 LEFT JOIN `twd_bbs`.`comments` AS `commentCount` ON `article`.`index` = `commentCount`.`article_index`
        WHERE `location`.`latitude` BETWEEN ${minLat} AND ${maxLat}
          AND `location`.`longitude` BETWEEN ${minLng} AND ${maxLng}
        GROUP BY `article`.`index`
    </select>

</mapper>











