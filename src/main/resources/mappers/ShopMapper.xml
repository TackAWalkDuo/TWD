<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.twd.take_a_walk_duo.mappers.IShopMapper">

    <select id="selectArticleCountByBoardId"
            resultType="int">
        SELECT COUNT(0)
        FROM `twd_bbs`.`articles`
    </select>

    <!--    <select id="selectArticlesByBoardId"-->
    <!--            resultType="dev.twdtake_a_walk_duo.vos.bbs.ArticleReadVo">-->
    <!--        SELECT `article`.`index` AS `index`,-->
    <!--        `article`.`user_email` AS `userEmail`,-->
    <!--        `article`.`board_id` AS `boardID`,-->
    <!--        `article`.`title` AS `title`,-->
    <!--        `article`.`view` AS `view`,-->
    <!--        `article`.`written_on` AS `writtenOn`,-->
    <!--        `article`.`modified_on` AS `modifiedOn`,-->
    <!--        `user`.`nickname` AS `userNickname`,-->
    <!--        COUNT(`commentCount`.`index`) AS `commentCount`-->

    <!--        FROM `twd_bbs`.`articles` AS `article`-->
    <!--        LEFT JOIN `twd_member`.`users` AS `user` ON `user`.`email` = `article`.`user_email`-->
    <!--        LEFT JOIN `twd_bbs`.`comments` AS `commentCount`-->
    <!--        ON `article`.`index` = `commentCount`.`article_index`-->
    <!--        WHERE `board_id` = #{boardId}-->
    <!--        <if twd="criterion != null and criterion.equals('title')">-->
    <!--            AND REPLACE(`article`.`title`, ' ', '') LIKE CONCAT('%', REPLACE(#{keyword}, ' ', ''), '%')-->
    <!--        </if>-->
    <!--        <if twd="criterion != null and criterion.equals('all')">-->
    <!--            AND (REPLACE(`article`.`title`, ' ', '') LIKE CONCAT('%', REPLACE(#{keyword}, ' ', ''), '%')-->
    <!--            OR REPLACE(`article`.`content`, ' ', '') LIKE CONCAT('%', REPLACE(#{keyword}, ' ', ''), '%'))-->
    <!--        </if>-->
    <!--        <if twd="criterion != null and criterion.equals('nickname')">-->
    <!--            AND BINARY `user`.`nickname` = #{keyword}-->
    <!--        </if>-->
    <!--        GROUP BY `index`-->
    <!--        ORDER BY `index` DESC-->
    <!--        LIMIT #{limit} OFFSET #{offset}-->
    <!--    </select>-->

    <!--위에꺼 수정한거임-->
    <select id="selectArticlesByBoardId"
            resultType="dev.twd.take_a_walk_duo.vos.shop.ProductVo">
        SELECT `article`.`index`         AS `index`,
               `article`.`user_email`    AS `userEmail`,
               `article`.`board_id`      AS `boardID`,
               `article`.`title`         AS `title`,
               `article`.`thumbnail`     AS `thumbnail`,
               `article`.`view`          AS `view`,
               `article`.`written_on`    AS `writtenOn`,
               `article`.`modified_on`   AS `modifiedOn`,
               `product`.`quantity`      AS `qunantity`,
               `product`.`price`         AS `price`,
               `product`.`category_text` AS 'categoryText'
        FROM `twd_bbs`.`articles` AS `article`
                 LEFT JOIN `twd_member`.`users` AS `user` ON `user`.`email` = `article`.`user_email`
                 LEFT JOIN `twd_shop`.`sale_product` AS `product` ON `article`.`index` = `product`.`article_index`
        WHERE `board_id` = 'shop'
          AND `product`.`category_text` = #{boardText}
        GROUP BY `index`
        ORDER BY `index` DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- shop/main용-->
    <select id="selectAllArticles"
            resultType="dev.twd.take_a_walk_duo.vos.shop.ProductVo">
        SELECT `article`.`index`         AS `index`,
               `article`.`user_email`    AS `userEmail`,
               `article`.`board_id`      AS `boardID`,
               `article`.`title`         AS `title`,
               `article`.`content`       AS `content`,
               `article`.`thumbnail`     AS `thumbnail`,
               `article`.`view`          AS `view`,
               `article`.`written_on`    AS `writtenOn`,
               `article`.`modified_on`   AS `modifiedOn`,
               `product`.`quantity`      AS `qunantity`,
               `product`.`price`         AS `price`,
               `product`.`category_text` AS 'categoryText',
               `product`.`text`          AS `text`
        FROM `twd_bbs`.`articles` AS `article`
                 LEFT JOIN `twd_member`.`users` AS `user` ON `user`.`email` = `article`.`user_email`
                 LEFT JOIN `twd_shop`.`sale_product` AS `product` ON `article`.`index` = `product`.`article_index`
        WHERE `board_id` = 'shop'
        GROUP BY `index`
        ORDER BY `index` DESC
        LIMIT 8
    </select>

    <!-- ㅇㅇ   -->
    <insert id="insertProduct"
            parameterType="dev.twd.take_a_walk_duo.entities.shop.SaleProductEntity"
            useGeneratedKeys="true"
            keyColumn="index"
            keyProperty="index">
        INSERT INTO `twd_shop`.`sale_product`
        (`article_index`, `quantity`, `cost`, `discount`, `price`, `profit`, `category_text`, `delivery_fee`)
        VALUES (#{articleIndex}, #{quantity}, #{cost}, #{discount}, #{price}, #{profit}, #{categoryText},
                #{deliveryFee});
    </insert>

    <insert id="insertShopArticle"
            useGeneratedKeys="true"
            keyProperty="index"
            keyColumn="index"
            parameterType="dev.twd.take_a_walk_duo.entities.bbs.ArticleEntity">
        INSERT INTO `twd_bbs`.`articles`
        (`user_email`, `board_id`, `title`, `content`, `thumbnail`, `thumbnail_type`, `view`, `written_on`,
         `modified_on`)
        VALUES (#{userEmail}, #{boardId}, #{title}, #{content}, #{thumbnail}, #{thumbnailType}, #{view},
                IFNULL(#{writtenOn}, DEFAULT(`written_on`)),
                IFNULL(#{modifiedOn}, DEFAULT(`modified_on`)));
    </insert>

    <select id="selectBoardById"
            resultType="dev.twd.take_a_walk_duo.entities.bbs.BoardEntity">
        SELECT `id`       AS `id`,
               `text`     AS `text`,
               `board_id` AS `boardId`,
               `order`    AS `order`
        FROM `twd_bbs`.`boards`
        WHERE BINARY `id` = #{id}
        LIMIT 1;
    </select>

    <select id="selectBoards"
            resultType="dev.twd.take_a_walk_duo.entities.bbs.BoardEntity">
        SELECT `id`       AS `id`,
               `text`     AS `text`,
               `board_id` AS `boardId`
        FROM `twd_bbs`.`boards`
        ORDER BY `order`
    </select>

    <select id="selectImageByIndex"
            resultType="dev.twd.take_a_walk_duo.entities.bbs.ImageEntity">
        SELECT `index`     AS `index`,
               `file_name` AS `fileName`,
               `file_mime` AS `fileMime`,
               `data`      AS `data`
        FROM `twd_bbs`.`images`
        WHERE `index` = #{index}
        LIMIT 1
    </select>

    <insert id="insertImage"
            useGeneratedKeys="true"
            keyColumn="index"
            keyProperty="index">
        INSERT INTO `twd_bbs`.`images`(`file_name`, `file_mime`, `data`)
        VALUES (#{fileName}, #{fileMime}, #{data})
    </insert>
</mapper>